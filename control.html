<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SMART DOOR SYSTEM</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body {
      background: #121212;
      color: #fff;
      font-family: Arial, sans-serif;
    }
    .accordion-button {
      background: #1f1f1f;
      color: #fff;
    }
    .accordion-button:not(.collapsed) {
      background: #333;
      color: #fff;
    }
    .accordion-body button {
      display: block;
      width: 100%;
      margin: 5px 0;
      border-radius: 10px;
      padding: 10px;
    }
    .live-card {
      background: #1f1f1f;
      border-radius: 12px;
      padding: 15px;
      margin-top: 20px;
    }
    video {
      width: 100%;
      border-radius: 12px;
      background: black;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <h1 class="text-center mb-4">SMART DOOR SYSTEM</h1>

    <div class="accordion" id="accordionPanelsStayOpenExample">

      <!-- ========== Smart Door Options ========== -->
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#panel1" aria-expanded="true">
            Smart Door System Options
          </button>
        </h2>
        <div id="panel1" class="accordion-collapse collapse show">
          <div class="accordion-body">
            <h5>Open Door</h5>
            <button class="btn btn-primary" onclick="sendCommand('open door all')">Open door & close it</button>
            <button class="btn btn-success" onclick="sendCommand('open door')">Open door only</button>
            <button class="btn btn-danger" onclick="sendCommand('close door')">Close door only</button>

            <h5 class="mt-3">Toggle Camera</h5>
            <button class="btn btn-info" onclick="sendCommand('start camera')">Start camera</button>
            <button class="btn btn-warning" onclick="sendCommand('stop camera')">Stop camera</button>

            <h5 class="mt-3">Toggle of the System</h5>
            <button class="btn btn-secondary" onclick="sendCommand('lock system')">Lock system</button>
            <button class="btn btn-light" onclick="sendCommand('unlock system')">Unlock system</button>

            <h5 class="mt-3">Penalty</h5>
            <button class="btn btn-danger" onclick="sendCommand('penalty activate')">Penalty Activate</button>
          </div>
        </div>
      </div>

      <!-- ========== Extra Options ========== -->
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panel2">
            Smart Door System Add-on Options
          </button>
        </h2>
        <div id="panel2" class="accordion-collapse collapse">
          <div class="accordion-body">
            <button class="btn btn-outline-primary" onclick="sendCommand('light on')">Light On</button>
            <button class="btn btn-outline-secondary" onclick="sendCommand('light off')">Light Off</button>
            <button class="btn btn-outline-info" onclick="sendCommand('fan on')">Fan On</button>
            <button class="btn btn-outline-dark" onclick="sendCommand('fan off')">Fan Off</button>
          </div>
        </div>
      </div>

      <!-- ========== Explanation ========== -->
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panel3">
            Smart Door System Explanation
          </button>
        </h2>
        <div id="panel3" class="accordion-collapse collapse">
          <div class="accordion-body">
            This is the smart door system control panel with camera, lock system, and add-on features.
          </div>
        </div>
      </div>
    </div>

    <!-- ========== Live Stream Section ========== -->
    <div class="live-card">
      <h3>ðŸ“¹ Live Stream</h3>
      <video id="remoteVideo" autoplay playsinline></video>
      <button class="btn btn-success mt-3" onclick="startStream()">Start Live</button>
    </div>
  </div>

  <!-- Firebase + Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyACQ7ot2G6wvmNRM_hmmTDK8p7zMBQ1w2c",
      authDomain: "smart-door-system-project.firebaseapp.com",
      databaseURL: "https://smart-door-system-project-default-rtdb.firebaseio.com",
      projectId: "smart-door-system-project",
      storageBucket: "smart-door-system-project.firebasestorage.app",
      messagingSenderId: "298920936811",
      appId: "1:298920936811:web:033b6b7af47d93d52f382e",
      measurementId: "G-HY1Y22VZJT"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Ø¥Ø±Ø³Ø§Ù„ Ø£ÙˆØ§Ù…Ø±
    async function sendCommand(cmd) {
      await set(ref(db, "commands/last"), {
        action: cmd,
        timestamp: Date.now()
      });
    }
    window.sendCommand = sendCommand;

    // ========== WebRTC ==========
    let pc;

    async function startStream() {
      pc = new RTCPeerConnection();

      pc.ontrack = (event) => {
        document.getElementById("remoteVideo").srcObject = event.streams[0];
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      // Ù†Ø¨Ø¹Ø« offer Ù„Ù„Ø¨Ø§ÙŠØ«ÙˆÙ† Ø¹Ø¨Ø± Firebase
      await set(ref(db, "commands/last"), {
        action: "webrtc_offer",
        sdp: offer.sdp,
        timestamp: Date.now()
      });

      // Ù†Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ù€ answer Ù…Ù† Ø¨Ø§ÙŠØ«ÙˆÙ†
      onValue(ref(db, "webrtc_answer"), async (snapshot) => {
        const data = snapshot.val();
        if (data && data.sdp && !pc.currentRemoteDescription) {
          const answer = new RTCSessionDescription({
            type: "answer",
            sdp: data.sdp
          });
          await pc.setRemoteDescription(answer);
        }
      });
    }
    window.startStream = startStream;
  </script>
</body>
</html>
