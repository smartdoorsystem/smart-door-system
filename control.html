<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Door System Control</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body {
      background: #f4f6f9;
      font-family: Arial, sans-serif;
    }
    .control-card {
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      background: #fff;
    }
    .control-card h3 {
      border-bottom: 1px solid #ddd;
      padding: 12px;
      margin: 0;
    }
    .btn {
      border-radius: 12px;
      padding: 10px 20px;
      margin: 5px;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <h1 class="text-center mb-4">üö™ Smart Door System Control</h1>

    <!-- ========== CONTROL BUTTONS ========== -->
    <div class="card control-card">
      <h3 class="p-3">üîò Options</h3>
      <div class="p-3">
        <button class="btn btn-primary" onclick="sendCommand('open door')">Open Door</button>
        <button class="btn btn-danger" onclick="sendCommand('close door')">Close Door</button>
        <button class="btn btn-success" onclick="sendCommand('start camera')">Start Camera</button>
        <button class="btn btn-warning" onclick="sendCommand('stop camera')">Stop Camera</button>
      </div>
    </div>

    <!-- ========== EXTRA FEATURES (ŸÖŸÜ ŸÖŸÑŸÅŸÉ ÿßŸÑÿ£ÿµŸÑŸä) ========== -->
    <div class="card control-card">
      <h3 class="p-3">‚öôÔ∏è Extra Controls</h3>
      <div class="p-3">
        <button class="btn btn-secondary" onclick="sendCommand('light on')">Light On</button>
        <button class="btn btn-dark" onclick="sendCommand('light off')">Light Off</button>
        <button class="btn btn-info" onclick="sendCommand('fan on')">Fan On</button>
        <button class="btn btn-outline-info" onclick="sendCommand('fan off')">Fan Off</button>
      </div>
    </div>

    <!-- ========== LIVE CAMERA STREAM (ÿßŸÑÿ¨ÿØŸäÿØ) ========== -->
    <div class="card control-card">
      <h3 class="p-3">üìπ Live Camera</h3>
      <video id="remoteVideo" autoplay playsinline style="width:100%; border-radius:12px;"></video>
      <button class="btn btn-success m-3" onclick="startStream()">Start Live</button>
    </div>
  </div>

  <!-- ========== FIREBASE + LOGIC ========== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyACQ7ot2G6wvmNRM_hmmTDK8p7zMBQ1w2c",
      authDomain: "smart-door-system-project.firebaseapp.com",
      databaseURL: "https://smart-door-system-project-default-rtdb.firebaseio.com",
      projectId: "smart-door-system-project",
      storageBucket: "smart-door-system-project.firebasestorage.app",
      messagingSenderId: "298920936811",
      appId: "1:298920936811:web:033b6b7af47d93d52f382e",
      measurementId: "G-HY1Y22VZJT"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ========== SEND COMMAND ==========
    async function sendCommand(cmd) {
      await set(ref(db, "commands/last"), {
        action: cmd,
        timestamp: Date.now()
      });
    }
    window.sendCommand = sendCommand;

    // ========== WEBRTC PART ==========
    let pc;

    async function startStream() {
      pc = new RTCPeerConnection();

      pc.ontrack = (event) => {
        document.getElementById("remoteVideo").srcObject = event.streams[0];
      };

      // ŸÜÿπŸÖŸÑ offer
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      // ŸÜÿ®ÿπÿ´ ÿßŸÑŸÄ offer ŸÑŸÑÿ®ÿßŸäÿ´ŸàŸÜ ÿπÿ®ÿ± Firebase
      await set(ref(db, "commands/last"), {
        action: "webrtc_offer",
        sdp: offer.sdp,
        timestamp: Date.now()
      });

      // ŸÜÿ≥ÿ™ŸÇÿ®ŸÑ ÿßŸÑŸÄ answer ŸÖŸÜ ÿßŸÑÿ®ÿßŸäÿ´ŸàŸÜ
      onValue(ref(db, "webrtc_answer"), async (snapshot) => {
        const data = snapshot.val();
        if (data && data.sdp && !pc.currentRemoteDescription) {
          const answer = new RTCSessionDescription({
            type: "answer",
            sdp: data.sdp
          });
          await pc.setRemoteDescription(answer);
        }
      });
    }
    window.startStream = startStream;
  </script>
</body>
</html>
